<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Content & Trend Viewer (Lazy)</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <style>
    /* ===== Theme ===== */
    :root{
      --bg:#0b0c10; --card:#111317; --border:#252a32; --muted:#9aa3af; --text:#f1f5f9;
      --heading:#f6dcc9; --accent:#ef9a73; --accent-strong:#e6764f;
      --table-head:#1b212a; --table-row:#12161d; --table-row-alt:#0f141b; --grid:#2a303a;
    }

    body{ padding:3rem 2rem; background:var(--bg); color:var(--text);
      font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,"Helvetica Neue",Arial,sans-serif;}
    .container{ max-width:90%; }

    .section-title{ color:var(--heading); font-weight:800; letter-spacing:-.02em; line-height:1.1; }

    /* Tabs */
    .nav-tabs{ border-bottom:1px solid var(--border); }
    .nav-tabs .nav-link{
      display:inline-flex; align-items:center; padding:.55rem 1rem; margin:0 .35rem; line-height:1.2;
      color:#b8c1cc; background:transparent; border:none!important; border-bottom:3px solid transparent;
      border-radius:.75rem;
    }
    .nav-tabs .nav-link:hover{ color:var(--text); }
    .nav-tabs .nav-link.active{
      color:var(--accent); background:rgba(255,255,255,.06); border-bottom-color:var(--accent);
      box-shadow: inset 0 -3px 0 var(--accent); font-weight:700;
    }

    .nav-pills .nav-link{ color:#cfd6df; background:transparent; }
    .nav-pills .nav-link:hover{ color:var(--text); }
    .nav-pills .nav-link.active{ background:#151a22; color:var(--accent); font-weight:600; border:1px solid var(--border); }
    .inner-tab-content{ padding-top:1.5rem; }

    /* Cards / panes */
    .main-tab-pane{
      background:var(--card); padding:2.5rem; border:1px solid var(--border); border-radius:1rem;
      box-shadow:0 10px 30px rgba(0,0,0,.35); margin-top:-1px;
    }

    /* Category header */
    .category-title{ color:var(--accent); font-size:1.25rem; padding-bottom:.75rem; margin-bottom:.75rem; border-bottom:1px solid var(--border); font-weight:700; }

    /* Tables */
    .table{ font-size:.95rem; border-collapse:separate; border-spacing:0;
      --bs-table-color:var(--text); --bs-table-bg:var(--table-row);
      --bs-table-striped-bg:var(--table-row-alt); --bs-table-striped-color:var(--text);
      --bs-table-hover-bg:var(--table-row-alt); --bs-table-hover-color:var(--text);
      --bs-table-border-color:var(--grid); color:var(--text);}
    .table thead th{ font-weight:700; background:var(--table-head); border-bottom:2px solid var(--grid); color:var(--text);}
    .table tbody tr td{ vertical-align:middle; border-top:1px solid var(--grid);}
    .table-hover tbody tr:hover{ background:var(--table-row-alt); color:var(--text);}
    .table th, .table td{ white-space:normal; word-break:break-word; }

    /* Trend cards */
    .trend-plot-container{
      width:100%; height:300px; border:1px solid var(--border); border-radius:1rem;
      background:var(--card); box-shadow:0 6px 20px rgba(0,0,0,.35);
    }

    .text-muted{ color:var(--muted)!important; }
    hr{ border-color:var(--border); opacity:1; }
    code{ color:var(--text); background:#151a22; border:1px solid var(--border); padding:.125rem .25rem; border-radius:.375rem; }

    /* ===== Mobile-first fixes ===== */
    /* Scrollable tabs with snap */
    .tabs-scroll{ overflow-x:auto; overflow-y:hidden; flex-wrap:nowrap; -webkit-overflow-scrolling:touch; gap:.25rem; scroll-snap-type:x proximity; }
    .tabs-scroll .nav-item{ flex:0 0 auto; scroll-snap-align:center; }
    .tabs-scroll::-webkit-scrollbar{ display:none; } /* hide iOS/Chrome scrollbar */
    .tabs-scroll{ scrollbar-width:none; }           /* hide Firefox scrollbar */

    @media (max-width: 576px){
      body{ padding:1rem; }
      .container{ max-width:100%; }
      .display-4{ font-size:1.75rem; }
      .main-tab-pane{ padding:1rem; border-radius:.75rem; }
      .nav .nav-link{ padding:.5rem .75rem; font-size:.9rem; }
      .category-title{ font-size:1.1rem; }
      .table{ font-size:.9rem; }
      .trend-plot-container{ height:220px; }
    }
  </style>
</head>
<body>
  <div class="container" id="app"></div>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
  <script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
  <script>
    /* -------- Config -------- */
    const PERSPECTIVE_CONFIG = { fm:"Foundation Model", ro:"Robotics", cv:"CV", nlp:"NLP", ml:"ML", siggraph:"Graphics", nature:"Nature", science:"Science" };
    const SORT_ORDER = ["fm","ro","cv","nlp","ml","siggraph","nature","science"];
    const SUB_TAB_ORDER = ["main","input","modeling","objective","output","recipes"];
    const PER_KEY_EXTRA_SUBS = { ro:["action","body","environment","joint","sensor"] };

    const APP_STATE = {
      survey:{ loadedCategories:new Set(), subLoaded:new Map() }
    };

    /* -------- Utils -------- */
    async function fetchJSON(url){
      try{ const res = await fetch(url,{cache:"no-store"}); if(!res.ok) return {ok:false,status:res.status,data:null}; return {ok:true,status:res.status,data:await res.json()}; }
      catch(e){ return {ok:false,status:0,data:null}; }
    }
    function chunk(arr, size){ const out=[]; for(let i=0;i<arr.length;i+=size) out.push(arr.slice(i,i+size)); return out; }
    function el(tag, attrs={}, html=""){
      const node=document.createElement(tag);
      Object.entries(attrs).forEach(([k,v])=>{ if(k==="class") node.className=v; else if(k.startsWith("data-")) node.setAttribute(k,v); else if(k==="for") node.htmlFor=v; else node.setAttribute(k,v); });
      if(html instanceof Node) node.appendChild(html); else if(Array.isArray(html)) html.forEach(c=>node.appendChild(c)); else node.innerHTML=html; return node;
    }
    function spinner(label="Loading…"){ return el("div",{class:"d-flex flex-column align-items-center text-muted my-3"},`<div class="spinner-border" role="status" aria-hidden="true"></div><div class="small mt-2">${label}</div>`); }
    async function filterExistingSubs(key, subs){
      const results=await Promise.all(subs.map(async s=>{ try{ const r=await fetch(`./assets/survey/${key}/${s}.json`,{cache:"no-store"}); return r.ok?s:null; }catch{ return null; } })); return results.filter(Boolean);
    }

    /* ====== TABLE RENDER: now wrapped in .table-responsive for mobile ====== */
    function renderTable(content_data){
      const container=el("div");
      if(!content_data || !Array.isArray(content_data.categories) || !content_data.categories.length){
        container.appendChild(el("p",{class:"text-muted mt-3"},"No valid 'categories' content found for this item."));
        return container;
      }
      for(const cat of content_data.categories){
        container.appendChild(el("h5",{class:"category-title mt-4"},cat.name||""));
        const table=el("table",{class:"table table-hover"},`
          <thead>
            <tr>
              <th style="width:20%;">Subcategory</th>
              <th style="width:40%;">What is Covered</th>
              <th style="width:40%;">Typical Examples</th>
            </tr>
          </thead>
          <tbody></tbody>
        `);
        const tbody=table.querySelector("tbody");
        (cat.subcategories||[]).forEach(sub=>{
          const tr=document.createElement("tr");
          tr.innerHTML=`<td>${sub?.name??""}</td><td>${sub?.what_is_covered??""}</td><td>${sub?.typical_examples??""}</td>`;
          tbody.appendChild(tr);
        });
        const wrap=el("div",{class:"table-responsive"});
        wrap.appendChild(table);
        container.appendChild(wrap);
      }
      return container;
    }

    /* ===== Survey ===== */
    function renderSurveyShell(){
      const section=el("div",{class:"survey-section mb-5"});

      const tabs=el("ul",{class:"nav nav-pills justify-content-start tabs-scroll",id:"survey-main-tabs",role:"tablist"});
      const tabsContent=el("div",{class:"tab-content",id:"survey-main-tabs-content"});

      SORT_ORDER.forEach((key,idx)=>{
        const name=PERSPECTIVE_CONFIG[key]||key.toUpperCase(); const isActive=idx===0?"active":"";
        const li=el("li",{class:"nav-item",role:"presentation"});
        const btn=el("button",{class:`nav-link ${isActive}`,id:`survey-${key}-tab`,type:"button",role:"tab","data-bs-toggle":"tab","data-bs-target":`#survey-${key}-pane`,"data-key":key},name);
        li.appendChild(btn); tabs.appendChild(li);

        const pane=el("div",{class:`tab-pane fade main-tab-pane ${isActive?"show active":""}`,id:`survey-${key}-pane`,role:"tabpanel"});
        pane.appendChild(spinner("Waiting to load…")); tabsContent.appendChild(pane);
      });

      section.appendChild(tabs); section.appendChild(tabsContent);
      section.addEventListener('shown.bs.tab',ev=>{ const key=ev.target?.dataset?.key; if(key) ensureSurveyCategoryLoaded(key); });
      return section;
    }

    async function ensureSurveyCategoryLoaded(key){
      if(APP_STATE.survey.loadedCategories.has(key)) return;
      const pane=document.getElementById(`survey-${key}-pane`); if(!pane) return;
      pane.innerHTML=""; pane.appendChild(spinner("Loading category…"));

      const filePath=`./assets/survey/${key}.json`; const dirPath=`./assets/survey/${key}`;
      const singleRes=await fetchJSON(filePath);
      if(singleRes.ok && singleRes.data){ pane.innerHTML=""; pane.appendChild(renderTable(singleRes.data));
        APP_STATE.survey.loadedCategories.add(key); return; }

      const manifestRes=await fetchJSON(`${dirPath}/manifest.json`);
      const manifest=manifestRes.ok && Array.isArray(manifestRes.data)?manifestRes.data:null;

      let candidateSubs=manifest?manifest.map(s=>s.replace(/\.json$/i,"")):[...SUB_TAB_ORDER,...(PER_KEY_EXTRA_SUBS[key]||[])];
      const seen=new Set();
      candidateSubs=candidateSubs.map(s=>String(s).replace(/\.json$/i,"").trim()).filter(s=>s && !seen.has(s) && seen.add(s));
      candidateSubs=await filterExistingSubs(key,candidateSubs);

      pane.innerHTML="";
      if(!candidateSubs.length){
        pane.appendChild(el("p",{class:"text-muted mt-2"},`No subfiles found in <code>assets/survey/${key}/</code>.`));
        APP_STATE.survey.loadedCategories.add(key); return;
      }

      const subTabs=el("ul",{class:"nav nav-pills tabs-scroll",id:`${key}-sub-tabs`,role:"tablist"});
      const subContent=el("div",{class:"tab-content inner-tab-content",id:`${key}-sub-tabs-content`});

      candidateSubs.forEach((sub,sidx)=>{
        const subActive=sidx===0?"active":"";
        const subLi=el("li",{class:"nav-item",role:"presentation"});
        const label=sub.replace(/_/g," ").replace(/\b\w/g,c=>c.toUpperCase());
        const subBtn=el("button",{class:`nav-link ${subActive}`,id:`${key}-${sub}-tab`,type:"button","data-bs-toggle":"tab","data-bs-target":`#${key}-${sub}-pane`,"data-key":key,"data-sub":sub},label);
        subLi.appendChild(subBtn); subTabs.appendChild(subLi);

        const subPane=el("div",{class:`tab-pane fade ${subActive?"show active":""}`,id:`${key}-${sub}-pane`,role:"tabpanel"});
        subPane.appendChild(spinner("Waiting to load…")); subContent.appendChild(subPane);
      });

      pane.appendChild(subTabs); pane.appendChild(subContent);
      APP_STATE.survey.subLoaded.set(key,new Set()); APP_STATE.survey.loadedCategories.add(key);

      pane.addEventListener('shown.bs.tab',ev=>{ const sub=ev.target?.dataset?.sub; const tabKey=ev.target?.dataset?.key; if(tabKey===key && sub) ensureSurveySubLoaded(key,sub); });
      ensureSurveySubLoaded(key,candidateSubs[0]);
    }

    async function ensureSurveySubLoaded(key, sub){
      const loadedSet=APP_STATE.survey.subLoaded.get(key); if(loadedSet && loadedSet.has(sub)) return;
      const pane=document.getElementById(`${key}-${sub}-pane`); if(!pane) return;
      pane.innerHTML=""; pane.appendChild(spinner("Loading…"));
      const subRes=await fetchJSON(`./assets/survey/${key}/${sub}.json`);
      pane.innerHTML="";
      if(subRes.ok && subRes.data){ pane.appendChild(renderTable(subRes.data)); loadedSet.add(sub); }
      else{ pane.appendChild(el("p",{class:"text-muted mt-2"},`No data found for <code>assets/survey/${key}/${sub}.json</code>.`)); }
    }

    (function main(){
      const app=document.getElementById("app");
      const surveySection=renderSurveyShell(); app.appendChild(surveySection);
      const firstSurveyKey=SORT_ORDER[0]; ensureSurveyCategoryLoaded(firstSurveyKey);
    })();
  </script>
</body>
</html>
